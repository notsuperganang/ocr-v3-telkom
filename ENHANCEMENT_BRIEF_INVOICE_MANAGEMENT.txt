================================================================================
                    ENHANCEMENT BRIEF
        TELKOM CONTRACT INVOICE MANAGEMENT SYSTEM
================================================================================

Document Version: 1.0
Date: January 24, 2026
Project: Telkom Contract Data Extraction System
Enhancement: Invoice Management & Payment Tracking

================================================================================
                        TABLE OF CONTENTS
================================================================================

1. EXECUTIVE SUMMARY
2. CURRENT STATE
3. BUSINESS REQUIREMENTS
4. PROPOSED SOLUTION
5. DATABASE SCHEMA CHANGES
6. BUSINESS LOGIC & RULES
7. API SPECIFICATIONS
8. UI/UX REQUIREMENTS
9. MIGRATION STRATEGY
10. TESTING REQUIREMENTS
11. IMPLEMENTATION TIMELINE
12. APPENDIX

================================================================================
1. EXECUTIVE SUMMARY
================================================================================

OBJECTIVE:
Develop a comprehensive invoice management system to replace manual spreadsheet 
processes for managing Telkom contract invoices, including termin and recurring 
payments with support for partial payments and document tracking.

KEY BENEFITS:
‚úÖ Automated invoice generation from contract data
‚úÖ Detailed payment tracking (partial payments, tax status)
‚úÖ Centralized document management (bukti bayar, BUPOT, tax documents)
‚úÖ Real-time invoice status tracking
‚úÖ Filter invoices by billing period (month/year)
‚úÖ Better visibility into outstanding payments

SCOPE:
- Extend existing term_payments and recurring_payments tables
- Create payment transaction tracking
- Implement document management for invoices
- Build unified invoice view interface
- Develop API endpoints for invoice operations
- Create UI for invoice list and detail management

OUT OF SCOPE:
- Accounting system integration (Phase 2)
- Automated email reminders (Phase 2)
- Payment gateway integration (Phase 2)

================================================================================
2. CURRENT STATE
================================================================================

CURRENT WORKFLOW:
1. Petugas input kontrak ‚Üí Auto-generate term_payments & recurring_payments
2. Payment tracking menggunakan kolom is_paid (boolean)
3. Single payment_proof field (one file per invoice)
4. No partial payment support
5. Manual tracking di spreadsheet untuk:
   - Multiple payments per invoice
   - Tax payment status (PPh 23, PPN)
   - Multiple documents (BUPOT, bukti bayar, etc)

PAIN POINTS:
‚ùå Cannot track multiple payments for one invoice
‚ùå No visibility into payment history
‚ùå Limited document storage (single file)
‚ùå No status differentiation (paid vs paid-pending-tax)
‚ùå Difficult to filter by billing period
‚ùå Manual work in spreadsheet prone to errors

EXISTING DATABASE TABLES:
- contracts
- term_payments (auto-generated from contract)
- recurring_payments (auto-generated from contract)
- witels, segments, users

================================================================================
3. BUSINESS REQUIREMENTS
================================================================================

FUNCTIONAL REQUIREMENTS:

FR-001: Invoice List Page
  - Filter by year and month (default: current month)
  - Filter by status (DRAFT, SENT, PARTIALLY_PAID, PAID, OVERDUE, etc)
  - Filter by contract, customer, witel, segment
  - Display columns: Invoice #, Customer, Contract, Type, Amount, Paid, 
    Status, Due Date
  - Summary cards: Total invoices, Outstanding amount, Paid this month, 
    Overdue count

FR-002: Invoice Detail Page
  - Display invoice information (number, contract, customer, amounts)
  - Show payment breakdown (subtotal, PPN, PPh 23, total)
  - Payment history table with dates, amounts, methods
  - Document section grouped by type
  - Actions: Add Payment, Upload Document, Update Status, Send Invoice, 
    Download PDF

FR-003: Payment Management
  - Support multiple payments per invoice (partial payments)
  - Track payment date, amount, method, reference number
  - Individual tax status per payment (PPh 23 paid?, PPN paid?)
  - Auto-calculate total paid_amount
  - Auto-update invoice status based on payments

FR-004: Document Management
  - Support multiple files per invoice
  - Document types: BUKTI_BAYAR, BUPOT_PPH23, BUKTI_BAYAR_PPH, 
    BUKTI_BAYAR_PPN, INVOICE_PDF, OTHER
  - Link documents to specific payments or general invoice
  - Track uploader, upload date, file metadata
  - Support PDF, JPG, PNG formats (max 10MB)

FR-005: Invoice Status Management (Dual Status System)
  - Invoice Lifecycle Status (invoice_status):
    * DRAFT: Auto-generated, not sent yet
    * SENT: Sent to customer
    * PARTIALLY_PAID: Partially paid
    * PAID: Fully paid with all taxes
    * PAID_PENDING_PPH23: Paid but PPh 23 outstanding
    * PAID_PENDING_PPH_PPN: Paid but PPh 23 + PPN outstanding
    * OVERDUE: Past due date and not fully paid
    * CANCELLED: Cancelled invoice
  - Payment Due Status (status - existing field):
    * PENDING: Future periods
    * DUE: Current period
    * OVERDUE: Past periods
    * PAID: Manually marked as paid (preserved)
    * CANCELLED: Manually cancelled (preserved)
  - Auto-update invoice_status based on payment rules
  - Auto-update status based on period dates (except PAID/CANCELLED)

FR-006: Auto-Population from Contract
  - When contract created, auto-generate invoices with:
    * Unique invoice number (format: INV/YYYY/MM/XXXXX)
    * Billing period (month/year from payment_date)
    * Due date (payment_date + 14 days)
    * invoice_status = DRAFT
    * status = calculated (PENDING/DUE/OVERDUE)
    * Calculated amounts (amount, PPN, PPh, total)
    * original_amount = extracted amount (immutable)
    * amount = extracted amount (mutable - staff can edit)

FR-007: Amount Editing
  - Staff can edit amount field when needed (e.g., corrections, adjustments)
  - original_amount field preserves the extracted value (audit trail)
  - When amount is edited:
    * ppn_amount recalculated (amount √ó 0.11)
    * pph_amount recalculated (amount √ó 0.02 if applicable)
    * total_amount recalculated (amount + ppn - pph)
    * outstanding_amount automatically updated
  - Audit trail maintained via original_amount

NON-FUNCTIONAL REQUIREMENTS:

NFR-001: Performance
  - Invoice list page load < 2 seconds
  - Support pagination (50 records per page)
  - Efficient queries using indexes

NFR-002: Data Integrity
  - Prevent duplicate invoice numbers
  - Ensure payment total ‚â§ invoice total
  - Maintain audit trail (created_by, updated_by, timestamps)

NFR-003: Security
  - Role-based access control (Admin, Finance Manager, Finance Staff, AM)
  - Document access restrictions
  - Secure file upload with validation

NFR-004: Backward Compatibility
  - Existing contracts and payments must continue to work
  - Legacy fields (is_paid, payment_proof) preserved
  - Gradual migration strategy

================================================================================
4. PROPOSED SOLUTION
================================================================================

SOLUTION ARCHITECTURE:

1. EXTEND EXISTING TABLES
   - Add new columns to term_payments and recurring_payments
   - Preserve existing columns for backward compatibility
   - Auto-populate new fields during contract creation

2. CREATE SUPPORTING TABLES
   - payment_transactions: Track multiple payments per invoice
   - invoice_documents: Store multiple documents with metadata

3. CREATE UNIFIED VIEW
   - v_invoices: Combine term + recurring payments into single queryable view
   - Include contract and witel information via JOINs

4. IMPLEMENT BUSINESS LOGIC
   - Auto-calculate invoice status based on payments
   - Auto-update paid_amount when payments added
   - Validate payment amounts and tax status

5. BUILD API LAYER
   - RESTful endpoints for CRUD operations
   - Polymorphic handling (term vs recurring)
   - File upload with validation

6. DEVELOP UI
   - Invoice list page with filters and summary
   - Invoice detail page with payment and document sections
   - Modal forms for adding payments and uploading documents

================================================================================
5. DATABASE SCHEMA CHANGES
================================================================================

CRITICAL: PPh 23 WITHHOLDING TAX LOGIC
--------------------------------------------------------------------------------

All Telkom contracts include PPh 23 (2% withholding tax). The payment flow:

1. Invoice shows total amount including PPN: amount
2. Customer withholds PPh 23 (2% of DPP) from payment: pph_amount
3. Customer pays net amount: net_payable_amount = amount - pph_amount
4. Customer deposits PPh 23 to tax office and provides BUPOT

Calculation Formula:
  base_amount = amount / 1.11          (DPP - Dasar Pengenaan Pajak)
  ppn_amount = base_amount √ó 0.11      (11% PPN)
  pph_amount = base_amount √ó 0.02      (2% PPh 23 - WITHHELD)
  net_payable_amount = amount - pph_amount (what customer actually pays)

Example:
  amount = 896,462,640
  base_amount = 896,462,640 / 1.11 = 807,624,000
  ppn_amount = 807,624,000 √ó 0.11 = 88,838,640
  pph_amount = 807,624,000 √ó 0.02 = 16,152,480 (withheld)
  net_payable_amount = 896,462,640 - 16,152,480 = 880,310,160

Payment validation must use net_payable_amount (not amount) as the limit.

5.1 ALTER TABLE: term_payments
--------------------------------------------------------------------------------

-- IMPORTANT: amount vs original_amount
-- - original_amount: IMMUTABLE, preserves extracted value from contract (audit trail)
-- - amount: MUTABLE, current/editable value (total invoice value including PPN)
-- - status: Payment due timing (PENDING, DUE, OVERDUE, PAID, CANCELLED)
-- - invoice_status: Invoice lifecycle (DRAFT, SENT, PARTIALLY_PAID, PAID, etc.)

-- TAX CALCULATION RULES (PPh 23 withholding):
-- All contracts have PPh 23 (2% withholding tax)
-- Formula: amount = base_amount √ó 1.11 (base + PPN)
--          base_amount = amount / 1.11 (DPP)
--          ppn_amount = base_amount √ó 0.11
--          pph_amount = base_amount √ó 0.02 (withheld from payment)
--          net_payable_amount = amount - pph_amount (what customer actually pays)

ALTER TABLE term_payments ADD COLUMN IF NOT EXISTS
    -- Invoice Info
    invoice_number VARCHAR(50) UNIQUE,
    invoice_status VARCHAR(30) DEFAULT 'DRAFT',
    due_date DATE,

    -- Billing Period
    billing_month INTEGER,
    billing_year INTEGER,

    -- Amount Breakdown (auto-calculated from amount)
    -- Note: amount is MUTABLE (staff can edit, triggers recalculation)
    -- Note: original_amount is IMMUTABLE (preserves extracted value)
    base_amount DECIMAL(15,2), -- DPP (Dasar Pengenaan Pajak) = amount / 1.11
    ppn_amount DECIMAL(15,2), -- PPN 11% = base_amount √ó 0.11
    pph_amount DECIMAL(15,2), -- PPh 23 (2% withholding) = base_amount √ó 0.02
    net_payable_amount DECIMAL(15,2), -- Net to customer = amount - pph_amount
    paid_amount DECIMAL(15,2) DEFAULT 0,

    -- Tax Status
    ppn_paid BOOLEAN DEFAULT FALSE,
    pph23_paid BOOLEAN DEFAULT FALSE,

    -- Metadata
    sent_date DATE,
    notes TEXT,
    updated_by UUID REFERENCES users(id);

-- Create Indexes
CREATE INDEX IF NOT EXISTS idx_term_billing_period
    ON term_payments(billing_year, billing_month);
CREATE INDEX IF NOT EXISTS idx_term_invoice_status
    ON term_payments(invoice_status);
CREATE INDEX IF NOT EXISTS idx_term_due_date
    ON term_payments(due_date);
CREATE INDEX IF NOT EXISTS idx_term_invoice_number
    ON term_payments(invoice_number);

-- Backfill existing data
UPDATE term_payments
SET
    invoice_status = CASE
        WHEN is_paid = TRUE THEN 'PAID'
        ELSE 'SENT'
    END,
    -- Calculate breakdown from amount (total invoice value)
    base_amount = amount / 1.11,
    ppn_amount = (amount / 1.11) * 0.11,
    pph_amount = (amount / 1.11) * 0.02,
    net_payable_amount = amount - ((amount / 1.11) * 0.02),
    paid_amount = CASE
        WHEN is_paid = TRUE THEN amount - ((amount / 1.11) * 0.02)
        ELSE 0
    END,
    ppn_paid = is_paid,
    pph23_paid = is_paid,
    billing_month = EXTRACT(MONTH FROM payment_date),
    billing_year = EXTRACT(YEAR FROM payment_date),
    due_date = payment_date + INTERVAL '14 days'
WHERE invoice_status IS NULL;

5.2 ALTER TABLE: recurring_payments
--------------------------------------------------------------------------------

-- IMPORTANT: amount vs original_amount
-- - original_amount: IMMUTABLE, preserves extracted value from contract (audit trail)
-- - amount: MUTABLE, current/editable value (total invoice value including PPN)
-- - status: Payment due timing (PENDING, DUE, OVERDUE, PAID, CANCELLED)
-- - invoice_status: Invoice lifecycle (DRAFT, SENT, PARTIALLY_PAID, PAID, etc.)

-- TAX CALCULATION RULES (PPh 23 withholding):
-- All contracts have PPh 23 (2% withholding tax)
-- Formula: amount = base_amount √ó 1.11 (base + PPN)
--          base_amount = amount / 1.11 (DPP)
--          ppn_amount = base_amount √ó 0.11
--          pph_amount = base_amount √ó 0.02 (withheld from payment)
--          net_payable_amount = amount - pph_amount (what customer actually pays)

ALTER TABLE recurring_payments ADD COLUMN IF NOT EXISTS
    -- Invoice Info
    invoice_number VARCHAR(50) UNIQUE,
    invoice_status VARCHAR(30) DEFAULT 'DRAFT',
    due_date DATE,

    -- Billing Period
    billing_month INTEGER,
    billing_year INTEGER,

    -- Amount Breakdown (auto-calculated from amount)
    -- Note: amount is MUTABLE (staff can edit, triggers recalculation)
    -- Note: original_amount is IMMUTABLE (preserves extracted value)
    base_amount DECIMAL(15,2), -- DPP (Dasar Pengenaan Pajak) = amount / 1.11
    ppn_amount DECIMAL(15,2), -- PPN 11% = base_amount √ó 0.11
    pph_amount DECIMAL(15,2), -- PPh 23 (2% withholding) = base_amount √ó 0.02
    net_payable_amount DECIMAL(15,2), -- Net to customer = amount - pph_amount
    paid_amount DECIMAL(15,2) DEFAULT 0,

    -- Tax Status
    ppn_paid BOOLEAN DEFAULT FALSE,
    pph23_paid BOOLEAN DEFAULT FALSE,

    -- Metadata
    sent_date DATE,
    notes TEXT,
    updated_by UUID REFERENCES users(id);

-- Create Indexes
CREATE INDEX IF NOT EXISTS idx_recurring_billing_period
    ON recurring_payments(billing_year, billing_month);
CREATE INDEX IF NOT EXISTS idx_recurring_invoice_status
    ON recurring_payments(invoice_status);
CREATE INDEX IF NOT EXISTS idx_recurring_due_date
    ON recurring_payments(due_date);
CREATE INDEX IF NOT EXISTS idx_recurring_invoice_number
    ON recurring_payments(invoice_number);

-- Backfill existing data
UPDATE recurring_payments
SET
    invoice_status = CASE
        WHEN is_paid = TRUE THEN 'PAID'
        ELSE 'SENT'
    END,
    -- Calculate breakdown from amount (total invoice value)
    base_amount = amount / 1.11,
    ppn_amount = (amount / 1.11) * 0.11,
    pph_amount = (amount / 1.11) * 0.02,
    net_payable_amount = amount - ((amount / 1.11) * 0.02),
    paid_amount = CASE
        WHEN is_paid = TRUE THEN amount - ((amount / 1.11) * 0.02)
        ELSE 0
    END,
    ppn_paid = is_paid,
    pph23_paid = is_paid,
    billing_month = EXTRACT(MONTH FROM payment_date),
    billing_year = EXTRACT(YEAR FROM payment_date),
    due_date = payment_date + INTERVAL '14 days'
WHERE invoice_status IS NULL;

5.3 CREATE TABLE: payment_transactions
--------------------------------------------------------------------------------

CREATE TABLE payment_transactions (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Reference to invoice (polymorphic)
    invoice_type VARCHAR(20) NOT NULL, -- 'TERM' or 'RECURRING'
    term_payment_id UUID REFERENCES term_payments(id) ON DELETE CASCADE,
    recurring_payment_id UUID REFERENCES recurring_payments(id) ON DELETE CASCADE,
    
    -- Payment Details
    payment_date DATE NOT NULL,
    amount DECIMAL(15,2) NOT NULL,
    payment_method VARCHAR(50), -- TRANSFER, CASH, GIRO, CHECK, etc
    reference_number VARCHAR(100), -- Bank reference number
    
    -- Tax Info
    ppn_included BOOLEAN DEFAULT FALSE,
    pph23_included BOOLEAN DEFAULT FALSE,
    
    -- Metadata
    notes TEXT,
    created_by UUID REFERENCES users(id),
    created_at TIMESTAMP DEFAULT NOW(),
    updated_at TIMESTAMP DEFAULT NOW(),
    
    -- Constraints
    CONSTRAINT chk_payment_reference CHECK (
        (term_payment_id IS NOT NULL AND recurring_payment_id IS NULL) OR
        (term_payment_id IS NULL AND recurring_payment_id IS NOT NULL)
    ),
    CONSTRAINT chk_payment_amount CHECK (amount > 0)
);

-- Indexes
CREATE INDEX idx_payment_term ON payment_transactions(term_payment_id);
CREATE INDEX idx_payment_recurring ON payment_transactions(recurring_payment_id);
CREATE INDEX idx_payment_date ON payment_transactions(payment_date);
CREATE INDEX idx_payment_created_at ON payment_transactions(created_at);

-- Comments
COMMENT ON TABLE payment_transactions IS 
    'Tracks individual payment transactions for invoices. Supports partial payments.';
COMMENT ON COLUMN payment_transactions.invoice_type IS 
    'Type of invoice: TERM or RECURRING';
COMMENT ON COLUMN payment_transactions.ppn_included IS 
    'Whether PPN tax was paid in this transaction';
COMMENT ON COLUMN payment_transactions.pph23_included IS 
    'Whether PPh 23 tax was paid in this transaction';

5.4 CREATE TABLE: invoice_documents
--------------------------------------------------------------------------------

CREATE TABLE invoice_documents (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    
    -- Reference to invoice (polymorphic)
    invoice_type VARCHAR(20) NOT NULL, -- 'TERM' or 'RECURRING'
    term_payment_id UUID REFERENCES term_payments(id) ON DELETE CASCADE,
    recurring_payment_id UUID REFERENCES recurring_payments(id) ON DELETE CASCADE,
    
    -- Reference to specific payment (optional)
    payment_transaction_id UUID REFERENCES payment_transactions(id) ON DELETE CASCADE,
    
    -- Document Type
    document_type VARCHAR(30) NOT NULL,
    -- Valid values: 
    -- 'BUKTI_BAYAR', 'BUPOT_PPH23', 'BUKTI_BAYAR_PPH', 
    -- 'BUKTI_BAYAR_PPN', 'INVOICE_PDF', 'FAKTUR_PAJAK', 'OTHER'
    
    -- File Info
    file_name VARCHAR(255) NOT NULL,
    file_path VARCHAR(500) NOT NULL,
    file_size INTEGER, -- in bytes
    mime_type VARCHAR(100),
    
    -- Metadata
    uploaded_by UUID REFERENCES users(id),
    uploaded_at TIMESTAMP DEFAULT NOW(),
    notes TEXT,
    
    -- Constraints
    CONSTRAINT chk_invoice_reference CHECK (
        (term_payment_id IS NOT NULL AND recurring_payment_id IS NULL) OR
        (term_payment_id IS NULL AND recurring_payment_id IS NOT NULL)
    ),
    CONSTRAINT chk_file_size CHECK (file_size <= 10485760) -- Max 10MB
);

-- Indexes
CREATE INDEX idx_doc_term ON invoice_documents(term_payment_id);
CREATE INDEX idx_doc_recurring ON invoice_documents(recurring_payment_id);
CREATE INDEX idx_doc_payment ON invoice_documents(payment_transaction_id);
CREATE INDEX idx_doc_type ON invoice_documents(document_type);
CREATE INDEX idx_doc_uploaded_at ON invoice_documents(uploaded_at);

-- Comments
COMMENT ON TABLE invoice_documents IS 
    'Stores documents related to invoices and payments';
COMMENT ON COLUMN invoice_documents.payment_transaction_id IS 
    'Optional: Link document to specific payment transaction';
COMMENT ON COLUMN invoice_documents.document_type IS 
    'Type of document: BUKTI_BAYAR, BUPOT_PPH23, etc';

5.5 CREATE VIEW: v_invoices
--------------------------------------------------------------------------------

CREATE OR REPLACE VIEW v_invoices AS
-- Term Payments as Invoices
SELECT
    'TERM' as invoice_type,
    tp.id,
    tp.invoice_number,
    tp.contract_id,
    tp.term_number as invoice_sequence,
    tp.invoice_status, -- Invoice lifecycle status
    tp.status as payment_due_status, -- Payment due timing status
    tp.payment_date as original_payment_date,
    tp.due_date,
    tp.billing_month,
    tp.billing_year,
    tp.original_amount, -- Immutable audit trail
    tp.amount, -- Mutable current value (total invoice)
    tp.base_amount, -- DPP (Dasar Pengenaan Pajak)
    tp.ppn_amount, -- PPN 11%
    tp.pph_amount, -- PPh 23 2% (withheld)
    tp.net_payable_amount, -- What customer actually pays
    tp.paid_amount,
    tp.ppn_paid,
    tp.pph23_paid,
    tp.is_paid as legacy_is_paid,
    tp.sent_date,
    tp.notes,
    tp.created_at,
    tp.updated_at,
    tp.updated_by,

    -- Contract Info
    c.contract_number,
    c.customer_name,
    c.npwp,
    c.customer_address,
    c.witel_id,
    c.segment,
    c.contract_start_date,
    c.contract_end_date,

    -- Witel Info
    w.name as witel_name,

    -- Calculate outstanding (based on net payable, not total amount)
    (tp.net_payable_amount - COALESCE(tp.paid_amount, 0)) as outstanding_amount,

    -- Payment progress percentage (based on net payable)
    CASE
        WHEN tp.net_payable_amount > 0
        THEN ROUND((COALESCE(tp.paid_amount, 0) / tp.net_payable_amount * 100), 2)
        ELSE 0
    END as payment_progress_pct

FROM term_payments tp
LEFT JOIN contracts c ON tp.contract_id = c.id
LEFT JOIN witels w ON c.witel_id = w.id

UNION ALL

-- Recurring Payments as Invoices
SELECT
    'RECURRING' as invoice_type,
    rp.id,
    rp.invoice_number,
    rp.contract_id,
    NULL as invoice_sequence,
    rp.invoice_status, -- Invoice lifecycle status
    rp.status as payment_due_status, -- Payment due timing status
    rp.payment_date as original_payment_date,
    rp.due_date,
    rp.billing_month,
    rp.billing_year,
    rp.original_amount, -- Immutable audit trail
    rp.amount, -- Mutable current value (total invoice)
    rp.base_amount, -- DPP (Dasar Pengenaan Pajak)
    rp.ppn_amount, -- PPN 11%
    rp.pph_amount, -- PPh 23 2% (withheld)
    rp.net_payable_amount, -- What customer actually pays
    rp.paid_amount,
    rp.ppn_paid,
    rp.pph23_paid,
    rp.is_paid as legacy_is_paid,
    rp.sent_date,
    rp.notes,
    rp.created_at,
    rp.updated_at,
    rp.updated_by,

    -- Contract Info
    c.contract_number,
    c.customer_name,
    c.npwp,
    c.customer_address,
    c.witel_id,
    c.segment,
    c.contract_start_date,
    c.contract_end_date,

    -- Witel Info
    w.name as witel_name,

    -- Calculate outstanding (based on net payable, not total amount)
    (rp.net_payable_amount - COALESCE(rp.paid_amount, 0)) as outstanding_amount,

    -- Payment progress percentage (based on net payable)
    CASE
        WHEN rp.net_payable_amount > 0
        THEN ROUND((COALESCE(rp.paid_amount, 0) / rp.net_payable_amount * 100), 2)
        ELSE 0
    END as payment_progress_pct

FROM recurring_payments rp
LEFT JOIN contracts c ON rp.contract_id = c.id
LEFT JOIN witels w ON c.witel_id = w.id;

-- Comments
COMMENT ON VIEW v_invoices IS 
    'Unified view of all invoices from term_payments and recurring_payments';

5.6 HELPER FUNCTIONS
--------------------------------------------------------------------------------

-- Function: Generate Invoice Number
CREATE OR REPLACE FUNCTION generate_invoice_number(
    p_year INTEGER,
    p_month INTEGER
) RETURNS VARCHAR AS $$
DECLARE
    v_sequence INTEGER;
    v_number VARCHAR;
BEGIN
    -- Get next sequence for the billing period
    SELECT COALESCE(MAX(
        CAST(SPLIT_PART(invoice_number, '/', 4) AS INTEGER)
    ), 0) + 1
    INTO v_sequence
    FROM (
        SELECT invoice_number FROM term_payments
        WHERE billing_year = p_year AND billing_month = p_month
        UNION ALL
        SELECT invoice_number FROM recurring_payments
        WHERE billing_year = p_year AND billing_month = p_month
    ) combined
    WHERE invoice_number IS NOT NULL;

    -- Format: INV/2026/01/00001
    v_number := 'INV/' || p_year || '/' ||
                LPAD(p_month::TEXT, 2, '0') || '/' ||
                LPAD(v_sequence::TEXT, 5, '0');

    RETURN v_number;
END;
$$ LANGUAGE plpgsql;

-- Function: Recalculate breakdown when amount changes
-- This must be called when amount is edited by staff
-- Formula: amount = total invoice value (including PPN)
--          base_amount = amount / 1.11 (DPP)
--          ppn_amount = base_amount √ó 0.11
--          pph_amount = base_amount √ó 0.02 (withheld)
--          net_payable_amount = amount - pph_amount
CREATE OR REPLACE FUNCTION recalculate_invoice_breakdown_trigger()
RETURNS TRIGGER AS $$
BEGIN
    -- Recalculate all breakdown fields from amount
    NEW.base_amount := NEW.amount / 1.11;
    NEW.ppn_amount := NEW.base_amount * 0.11;
    NEW.pph_amount := NEW.base_amount * 0.02;
    NEW.net_payable_amount := NEW.amount - NEW.pph_amount;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Function: Update Invoice Status (invoice lifecycle)
-- IMPORTANT: Uses net_payable_amount for payment comparison
-- Customer pays net_payable_amount (amount - PPh 23 withholding)
-- PAID_PENDING_PPH23 = when customer paid full net amount but BUPOT not uploaded
CREATE OR REPLACE FUNCTION update_invoice_status_trigger()
RETURNS TRIGGER AS $$
DECLARE
    v_new_invoice_status VARCHAR(30);
BEGIN
    -- Determine new INVOICE_STATUS based on payment
    -- Use net_payable_amount (not amount) because PPh 23 is withheld
    IF NEW.paid_amount >= NEW.net_payable_amount THEN
        IF NEW.ppn_paid AND NEW.pph23_paid THEN
            v_new_invoice_status := 'PAID';
        ELSIF NOT NEW.pph23_paid THEN
            -- Customer paid full net amount, but waiting for BUPOT document
            v_new_invoice_status := 'PAID_PENDING_PPH23';
        ELSE
            v_new_invoice_status := 'PAID_PENDING_PPN';
        END IF;
    ELSIF NEW.paid_amount > 0 THEN
        v_new_invoice_status := 'PARTIALLY_PAID';
    ELSIF NEW.due_date < CURRENT_DATE THEN
        v_new_invoice_status := 'OVERDUE';
    ELSE
        v_new_invoice_status := COALESCE(NEW.invoice_status, 'SENT');
    END IF;

    NEW.invoice_status := v_new_invoice_status;

    -- Update legacy is_paid field for backward compatibility
    NEW.is_paid := (v_new_invoice_status = 'PAID');

    RETURN NEW;
END;
$$ LANGUAGE plpgsql;

-- Apply recalculate trigger to term_payments (when amount edited)
CREATE TRIGGER trg_recalc_term_breakdown
    BEFORE INSERT OR UPDATE ON term_payments
    FOR EACH ROW
    WHEN (NEW.amount IS NOT NULL AND
          (TG_OP = 'INSERT' OR OLD.amount IS DISTINCT FROM NEW.amount))
    EXECUTE FUNCTION recalculate_invoice_breakdown_trigger();

-- Apply recalculate trigger to recurring_payments (when amount edited)
CREATE TRIGGER trg_recalc_recurring_breakdown
    BEFORE INSERT OR UPDATE ON recurring_payments
    FOR EACH ROW
    WHEN (NEW.amount IS NOT NULL AND
          (TG_OP = 'INSERT' OR OLD.amount IS DISTINCT FROM NEW.amount))
    EXECUTE FUNCTION recalculate_invoice_breakdown_trigger();

-- Apply invoice status trigger to term_payments (when payment added)
CREATE TRIGGER trg_update_term_invoice_status
    BEFORE UPDATE ON term_payments
    FOR EACH ROW
    WHEN (OLD.paid_amount IS DISTINCT FROM NEW.paid_amount OR
          OLD.ppn_paid IS DISTINCT FROM NEW.ppn_paid OR
          OLD.pph23_paid IS DISTINCT FROM NEW.pph23_paid)
    EXECUTE FUNCTION update_invoice_status_trigger();

-- Apply invoice status trigger to recurring_payments (when payment added)
CREATE TRIGGER trg_update_recurring_invoice_status
    BEFORE UPDATE ON recurring_payments
    FOR EACH ROW
    WHEN (OLD.paid_amount IS DISTINCT FROM NEW.paid_amount OR
          OLD.ppn_paid IS DISTINCT FROM NEW.ppn_paid OR
          OLD.pph23_paid IS DISTINCT FROM NEW.pph23_paid)
    EXECUTE FUNCTION update_invoice_status_trigger();

================================================================================
6. BUSINESS LOGIC & RULES
================================================================================

6.1 INVOICE STATUS RULES
--------------------------------------------------------------------------------

IMPORTANT: TWO SEPARATE STATUS DIMENSIONS

1. INVOICE_STATUS (Invoice Lifecycle - NEW field)
   Tracks the invoice payment and tax completion status

2. STATUS (Payment Due Timing - EXISTING field)
   Tracks PENDING ‚Üí DUE ‚Üí OVERDUE ‚Üí PAID ‚Üí CANCELLED
   (Auto-calculated based on period dates)

Invoice Status Transition Logic:

DRAFT ‚Üí SENT
  Trigger: User clicks "Send Invoice" button
  Action: Set sent_date = CURRENT_DATE, invoice_status = 'SENT'

SENT ‚Üí PARTIALLY_PAID
  Trigger: Payment added where 0 < paid_amount < net_payable_amount
  Action: Auto-update invoice_status to 'PARTIALLY_PAID'

SENT/PARTIALLY_PAID ‚Üí PAID
  Trigger: paid_amount >= net_payable_amount AND ppn_paid = TRUE AND pph23_paid = TRUE
  Action: Auto-update invoice_status to 'PAID', set is_paid = TRUE
  Note: Customer paid full net amount, and BUPOT uploaded (pph23_paid = TRUE)

SENT/PARTIALLY_PAID ‚Üí PAID_PENDING_PPH23
  Trigger: paid_amount >= net_payable_amount AND pph23_paid = FALSE
  Action: Auto-update invoice_status to 'PAID_PENDING_PPH23'
  Note: Customer paid full net amount, but waiting for BUPOT document

SENT/PARTIALLY_PAID ‚Üí PAID_PENDING_PPN
  Trigger: paid_amount >= net_payable_amount AND ppn_paid = FALSE AND pph23_paid = TRUE
  Action: Auto-update invoice_status to 'PAID_PENDING_PPN'
  Note: Rare case - payment complete but PPN documentation pending

ANY ‚Üí OVERDUE (invoice_status)
  Trigger: due_date < CURRENT_DATE AND invoice_status NOT IN ('PAID', 'CANCELLED')
  Action: Auto-update invoice_status to 'OVERDUE'

ANY ‚Üí CANCELLED (invoice_status)
  Trigger: User manually cancels invoice
  Action: Set invoice_status = 'CANCELLED'

Payment Due Status (existing status field):
  - PENDING: Future periods (auto-calculated)
  - DUE: Current period (auto-calculated)
  - OVERDUE: Past periods (auto-calculated)
  - PAID: Manual status (preserved, never auto-updated)
  - CANCELLED: Manual status (preserved, never auto-updated)

6.2 PAYMENT VALIDATION RULES
--------------------------------------------------------------------------------

Rule 1: Payment Amount Limit
  - SUM(payment_transactions.amount) MUST NOT exceed invoice.net_payable_amount
  - Validation: Before insert payment_transaction
  - Reason: Customer pays net_payable_amount (invoice amount minus PPh 23 withholding)
  - Example: If invoice amount = 896,462,640 and pph_amount = 16,152,480,
             then net_payable_amount = 880,310,160 (this is the payment limit)

Rule 2: Payment Date Validation
  - payment_date MUST NOT be before invoice creation date
  - payment_date SHOULD NOT be in the future (warning only)

Rule 3: Tax Status Tracking
  - ppn_included and pph23_included are per-payment flags
  - Invoice-level ppn_paid = TRUE if ANY payment has ppn_included = TRUE
  - Invoice-level pph23_paid = TRUE if ANY payment has pph23_included = TRUE

Rule 4: Document Requirements
  - BUPOT_PPH23 document SHOULD be uploaded if pph23_paid = TRUE
  - BUKTI_BAYAR MUST be uploaded for each payment transaction
  - Warning if payment added without bukti_bayar

6.3 AUTO-POPULATION RULES (Contract Creation)
--------------------------------------------------------------------------------

When contract is created, auto-generate invoices with:

For TERM payments:
  - invoice_number = generate_invoice_number(year, month)
  - invoice_status = 'DRAFT'
  - status = 'PENDING' (or calculated based on period date)
  - billing_month = EXTRACT(MONTH FROM payment_date)
  - billing_year = EXTRACT(YEAR FROM payment_date)
  - due_date = payment_date + INTERVAL '14 days'
  - amount = extracted invoice value (including PPN)
  - base_amount = amount / 1.11 (auto-calculated)
  - ppn_amount = base_amount √ó 0.11 (auto-calculated)
  - pph_amount = base_amount √ó 0.02 (auto-calculated)
  - net_payable_amount = amount - pph_amount (auto-calculated)
  - paid_amount = 0
  - ppn_paid = FALSE
  - pph23_paid = FALSE

For RECURRING payments:
  - Same as term, but generate for each period (12 months ahead)
  - Each period gets unique invoice_number

6.4 CALCULATION RULES (PPh 23 Withholding)
--------------------------------------------------------------------------------

IMPORTANT: All contracts have PPh 23 (2% withholding tax)
Customer pays net_payable_amount (invoice amount minus withheld PPh 23)

Invoice Amount Breakdown:
  amount = total invoice value including PPN (MUTABLE - staff can edit)
  original_amount = original extracted amount (IMMUTABLE - audit trail)
  base_amount = amount / 1.11 (DPP - Dasar Pengenaan Pajak)
  ppn_amount = base_amount √ó 0.11 (11% PPN)
  pph_amount = base_amount √ó 0.02 (2% PPh 23 - WITHHELD from payment)
  net_payable_amount = amount - pph_amount (what customer actually pays)

Example Calculation:
  Given amount = 896,462,640:
  - base_amount = 896,462,640 / 1.11 = 807,624,000
  - ppn_amount = 807,624,000 √ó 0.11 = 88,838,640
  - pph_amount = 807,624,000 √ó 0.02 = 16,152,480 (withheld)
  - net_payable_amount = 896,462,640 - 16,152,480 = 880,310,160

Outstanding:
  outstanding_amount = net_payable_amount - paid_amount

Payment Progress:
  payment_progress_pct = (paid_amount / net_payable_amount) √ó 100

Amount Edit Handling:
  When staff edits amount:
  1. Update amount field (original_amount stays unchanged)
  2. Trigger auto-recalculates ALL breakdown fields:
     - base_amount = amount / 1.11
     - ppn_amount = base_amount √ó 0.11
     - pph_amount = base_amount √ó 0.02
     - net_payable_amount = amount - pph_amount
  3. outstanding_amount automatically updates
  4. Audit trail preserved via original_amount

Payment Validation:
  - Payments are validated against net_payable_amount (not amount)
  - Customer cannot pay more than net_payable_amount
  - PPh 23 (pph_amount) is withheld by customer and paid to tax office

================================================================================
7. API SPECIFICATIONS
================================================================================

7.1 GET /api/invoices
--------------------------------------------------------------------------------

Description: Get list of invoices with filters

Query Parameters:
  - year (required): Billing year (e.g., 2026)
  - month (required): Billing month (1-12)
  - status (optional): Invoice status (comma-separated)
  - witel_id (optional): Filter by witel
  - segment (optional): Filter by segment
  - customer_name (optional): Search by customer name
  - contract_number (optional): Search by contract number
  - page (optional, default=1): Page number
  - limit (optional, default=50): Records per page

Response:
{
  "data": [
    {
      "id": "uuid",
      "invoice_type": "TERM" | "RECURRING",
      "invoice_number": "INV/2026/01/00001",
      "contract_id": "uuid",
      "contract_number": "K.TEL.56/...",
      "customer_name": "SMK NEGERI 1 BIREUN",
      "witel_name": "901 - Aceh",
      "segment": "DGS",
      "invoice_status": "SENT",
      "payment_due_status": "DUE",
      "original_amount": 896462640.00,
      "amount": 896462640.00,
      "base_amount": 807624000.00,
      "ppn_amount": 88838640.00,
      "pph_amount": 16152480.00,
      "net_payable_amount": 880310160.00,
      "paid_amount": 0.00,
      "outstanding_amount": 880310160.00,
      "payment_progress_pct": 0.00,
      "due_date": "2026-02-15",
      "billing_month": 1,
      "billing_year": 2026,
      "ppn_paid": false,
      "pph23_paid": false
    }
  ],
  "summary": {
    "total_invoices": 45,
    "total_amount": 1500000000.00,
    "total_paid": 800000000.00,
    "total_outstanding": 700000000.00,
    "overdue_count": 5
  },
  "pagination": {
    "page": 1,
    "limit": 50,
    "total_pages": 1,
    "total_records": 45
  }
}

7.2 GET /api/invoices/{invoice_type}/{id}
--------------------------------------------------------------------------------

Description: Get invoice detail with payment history and documents

Path Parameters:
  - invoice_type: "term" or "recurring"
  - id: Invoice UUID

Response:
{
  "invoice": {
    "id": "uuid",
    "invoice_type": "TERM",
    "invoice_number": "INV/2026/01/00001",
    "contract_id": "uuid",
    "contract_number": "K.TEL.56/...",
    "customer_name": "SMK NEGERI 1 BIREUN",
    "customer_address": "Jl. Taman Siswa...",
    "npwp": "00.124.790.7-101.000.0492",
    "invoice_status": "PARTIALLY_PAID",
    "payment_due_status": "DUE",
    "original_amount": 896462640.00,
    "amount": 896462640.00,
    "base_amount": 807624000.00,
    "ppn_amount": 88838640.00,
    "pph_amount": 16152480.00,
    "net_payable_amount": 880310160.00,
    "paid_amount": 500000000.00,
    "outstanding_amount": 380310160.00,
    "payment_progress_pct": 56.80,
    "ppn_paid": false,
    "pph23_paid": false,
    "due_date": "2026-02-15",
    "sent_date": "2026-01-10",
    "notes": null
  },
  "payments": [
    {
      "id": "uuid",
      "payment_date": "2026-01-15",
      "amount": 500000000.00,
      "payment_method": "TRANSFER",
      "reference_number": "TRF123456789",
      "ppn_included": false,
      "pph23_included": false,
      "notes": "Pembayaran pertama (partial)",
      "created_by": "user_name",
      "created_at": "2026-01-15T10:30:00Z",
      "documents": [
        {
          "id": "uuid",
          "document_type": "BUKTI_BAYAR",
          "file_name": "transfer_500jt.jpg",
          "file_path": "/uploads/invoices/...",
          "file_size": 512000,
          "uploaded_at": "2026-01-15T10:35:00Z"
        }
      ]
    }
  ],
  "documents": [
    {
      "id": "uuid",
      "document_type": "INVOICE_PDF",
      "file_name": "INV_2026_01_00001.pdf",
      "file_path": "/uploads/invoices/...",
      "file_size": 256000,
      "payment_id": null,
      "uploaded_by": "system",
      "uploaded_at": "2026-01-10T08:00:00Z"
    }
  ],
  "contract": {
    "contract_number": "K.TEL.56/...",
    "contract_start": "2024-09-09",
    "contract_end": "2025-09-08",
    "witel_name": "901 - Aceh",
    "segment": "DGS"
  }
}

7.3 POST /api/invoices/{invoice_type}/{id}/payments
--------------------------------------------------------------------------------

Description: Add payment to invoice

Path Parameters:
  - invoice_type: "term" or "recurring"
  - id: Invoice UUID

Request Body:
{
  "payment_date": "2026-01-15",
  "amount": 500000000.00,
  "payment_method": "TRANSFER",
  "reference_number": "TRF123456789",
  "ppn_included": false,
  "pph23_included": false,
  "notes": "Pembayaran pertama (partial)"
}

Response:
{
  "success": true,
  "payment_id": "uuid",
  "invoice_updated": {
    "paid_amount": 500000000.00,
    "outstanding_amount": 380310160.00,
    "invoice_status": "PARTIALLY_PAID",
    "payment_due_status": "DUE"
  }
}

Validations:
  - payment_date is required
  - amount must be > 0
  - amount must not exceed net_payable_amount (not invoice amount)
  - payment_date must not be before invoice creation

Note: Validation uses net_payable_amount because customer pays net amount
      (invoice amount minus PPh 23 withholding)

7.4 POST /api/invoices/{invoice_type}/{id}/documents
--------------------------------------------------------------------------------

Description: Upload document for invoice

Path Parameters:
  - invoice_type: "term" or "recurring"
  - id: Invoice UUID

Request Body (multipart/form-data):
  - file: File (required)
  - document_type: String (required)
    Options: BUKTI_BAYAR, BUPOT_PPH23, BUKTI_BAYAR_PPH, 
             BUKTI_BAYAR_PPN, INVOICE_PDF, FAKTUR_PAJAK, OTHER
  - payment_transaction_id: UUID (optional) - link to specific payment
  - notes: String (optional)

Response:
{
  "success": true,
  "document_id": "uuid",
  "file_path": "/uploads/invoices/term-001/bupot_123.pdf",
  "file_size": 512000
}

Validations:
  - file is required
  - file size <= 10MB
  - mime_type must be: application/pdf, image/jpeg, image/png
  - document_type must be valid enum value

7.5 GET /api/invoices/{invoice_type}/{id}/documents
--------------------------------------------------------------------------------

Description: Get all documents for an invoice

Path Parameters:
  - invoice_type: "term" or "recurring"
  - id: Invoice UUID

Query Parameters:
  - document_type (optional): Filter by document type

Response:
{
  "documents": [
    {
      "id": "uuid",
      "document_type": "BUKTI_BAYAR",
      "file_name": "transfer.jpg",
      "file_path": "/uploads/invoices/...",
      "file_size": 512000,
      "mime_type": "image/jpeg",
      "payment_transaction": {
        "id": "uuid",
        "payment_date": "2026-01-15",
        "amount": 20000000.00
      },
      "uploaded_by": "user_name",
      "uploaded_at": "2026-01-15T10:35:00Z",
      "notes": null
    }
  ]
}

7.6 PUT /api/invoices/{invoice_type}/{id}/status
--------------------------------------------------------------------------------

Description: Update invoice status (manual override)

Path Parameters:
  - invoice_type: "term" or "recurring"
  - id: Invoice UUID

Request Body:
{
  "invoice_status": "SENT" | "CANCELLED",
  "notes": "Reason for status change"
}

Response:
{
  "success": true,
  "invoice": {
    "id": "uuid",
    "invoice_number": "INV/2026/01/00001",
    "invoice_status": "SENT",
    "payment_due_status": "DUE",
    "sent_date": "2026-01-10"
  }
}

7.7 GET /api/invoices/export
--------------------------------------------------------------------------------

Description: Export invoices to Excel

Query Parameters:
  - Same as GET /api/invoices
  - format: "xlsx" | "csv" (default: xlsx)

Response:
  - Content-Type: application/vnd.openxmlformats-officedocument.spreadsheetml.sheet
  - Content-Disposition: attachment; filename="invoices_2026_01.xlsx"

Excel Columns:
  - Invoice Number
  - Invoice Type
  - Customer Name
  - Contract Number
  - Witel
  - Segment
  - Total Amount
  - Paid Amount
  - Outstanding Amount
  - Status
  - Due Date
  - Payment Progress %

7.8 POST /api/invoices/{invoice_type}/{id}/send
--------------------------------------------------------------------------------

Description: Send invoice to customer via email

Path Parameters:
  - invoice_type: "term" or "recurring"
  - id: Invoice UUID

Request Body:
{
  "recipient_email": "bakribobob@gmail.com",
  "cc_emails": ["finance@smkn1bireun.sch.id"],
  "subject": "Invoice #INV/2026/01/00001",
  "message": "Terlampir invoice untuk pembayaran..."
}

Response:
{
  "success": true,
  "email_sent": true,
  "sent_date": "2026-01-10T09:00:00Z"
}

Actions:
  - Generate invoice PDF
  - Send email with PDF attachment
  - Update invoice.sent_date
  - Update invoice.status to 'SENT' if currently 'DRAFT'

================================================================================
8. UI/UX REQUIREMENTS
================================================================================

8.1 INVOICE LIST PAGE
--------------------------------------------------------------------------------

Route: /invoices

Layout:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ üìã Invoice Management                                               ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Total        ‚îÇ ‚îÇ Outstanding  ‚îÇ ‚îÇ Paid         ‚îÇ ‚îÇ Overdue    ‚îÇ ‚îÇ
‚îÇ ‚îÇ Rp 1.5B      ‚îÇ ‚îÇ Rp 700M      ‚îÇ ‚îÇ Rp 800M      ‚îÇ ‚îÇ 5 invoices ‚îÇ ‚îÇ
‚îÇ ‚îÇ 45 invoices  ‚îÇ ‚îÇ              ‚îÇ ‚îÇ              ‚îÇ ‚îÇ            ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ Filters:                                                            ‚îÇ
‚îÇ [ Jan 2026 ‚ñº] [Status: All ‚ñº] [Witel: All ‚ñº] [üîç Search...]       ‚îÇ
‚îÇ                                                    [Export Excel]   ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ Invoice #        Customer      Contract  Amount      Status   ‚îÇ ‚îÇ
‚îÇ ‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§ ‚îÇ
‚îÇ ‚îÇ INV/2026/01/001  SMK NEGERI 1  K.TEL..   Rp 40.7M  [SENT]   ‚îÇ ‚îÇ
‚îÇ ‚îÇ INV/2026/01/002  PT LKMS       K.TEL..   Rp 25.1M  [PAID]   ‚îÇ ‚îÇ
‚îÇ ‚îÇ ...                                                           ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                 [‚Üê 1 2 3 4 5 ‚Üí]    ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Components:
1. Summary Cards (4 cards at top)
   - Total invoices + total amount
   - Outstanding amount
   - Paid this month
   - Overdue count (red alert)

2. Filter Bar
   - Month/Year selector (default: current month)
   - Status multi-select dropdown
   - Witel dropdown
   - Segment dropdown
   - Search box (customer name, contract number, invoice number)
   - Export to Excel button

3. Invoice Table
   Columns:
   - Invoice Number (clickable ‚Üí detail page)
   - Invoice Type (badge: TERM or RECURRING)
   - Customer Name
   - Contract Number
   - Witel
   - Total Amount (formatted: Rp 40.799.160)
   - Paid Amount
   - Outstanding Amount
   - Payment Progress (progress bar)
   - Status (colored badge)
   - Due Date
   - Actions (View, Send, Mark Paid)

4. Pagination
   - 50 records per page
   - Page selector

Status Badge Colors:
  - DRAFT: Gray
  - SENT: Blue
  - PARTIALLY_PAID: Orange
  - PAID: Green
  - PAID_PENDING_PPH23: Yellow
  - PAID_PENDING_PPH_PPN: Orange-Yellow
  - OVERDUE: Red
  - CANCELLED: Dark Gray

8.2 INVOICE DETAIL PAGE
--------------------------------------------------------------------------------

Route: /invoices/{invoice_type}/{id}

Layout:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ ‚Üê Back to List              Invoice: INV/2026/01/00001             ‚îÇ
‚îÇ                                                   [üü° PARTIALLY PAID]‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                                     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ INVOICE INFO        ‚îÇ ‚îÇ CUSTOMER INFO                          ‚îÇ ‚îÇ
‚îÇ ‚îÇ                     ‚îÇ ‚îÇ SMK NEGERI 1 BIREUN                    ‚îÇ ‚îÇ
‚îÇ ‚îÇ Number: INV/2026..  ‚îÇ ‚îÇ NPWP: 00.124.790.7-101.000.0492       ‚îÇ ‚îÇ
‚îÇ ‚îÇ Type: TERM          ‚îÇ ‚îÇ Address: Jl. Taman Siswa...           ‚îÇ ‚îÇ
‚îÇ ‚îÇ Contract: K.TEL..   ‚îÇ ‚îÇ                                        ‚îÇ ‚îÇ
‚îÇ ‚îÇ Due Date: 15 Feb    ‚îÇ ‚îÇ Contact Person: Bakri                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ Status: Partial Paid‚îÇ ‚îÇ Email: bakribobob@gmail.com           ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ üí∞ AMOUNT BREAKDOWN (with PPh 23 Withholding)                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ Base Amount (DPP):     Rp 807.624.000                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ PPN 11%:              Rp  88.838.640                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ Total Invoice:         Rp 896.462.640                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ PPh 23 (2% withheld): -Rp  16.152.480                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ                              ‚îÇ ‚îÇ
‚îÇ ‚îÇ Net Payable:           Rp 880.310.160                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ Paid:                  Rp 500.000.000                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ Outstanding:           Rp 380.310.160                           ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ Progress: [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë‚ñë] 56.8%                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ Tax Status: PPn ‚ùå | PPh 23 ‚ùå (waiting for BUPOT)             ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ Note: Customer pays Net Payable amount (Total - PPh withheld)  ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ üìã PAYMENT HISTORY                          [+ Add Payment]     ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÇ Payment #1 - 15 Jan 2026                                  ‚îÇ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÇ Amount: Rp 500.000.000 (partial payment)                 ‚îÇ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÇ Method: TRANSFER                                          ‚îÇ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÇ Ref: TRF123456789                                         ‚îÇ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÇ Tax: PPn ‚ùå | PPh 23 ‚ùå                                   ‚îÇ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÇ                                                           ‚îÇ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÇ Documents:                                                ‚îÇ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îÇ üìÑ transfer_500jt.jpg [View] [Download]                  ‚îÇ  ‚îÇ ‚îÇ
‚îÇ ‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò  ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ üìé INVOICE DOCUMENTS                        [+ Upload]          ‚îÇ ‚îÇ
‚îÇ ‚îÇ                                                                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ üìÑ Invoice PDF              [View] [Download]                  ‚îÇ ‚îÇ
‚îÇ ‚îÇ üìÑ BUPOT PPh 23            ‚ö†Ô∏è Not uploaded yet                 ‚îÇ ‚îÇ
‚îÇ ‚îÇ üìÑ Bukti Bayar PPN         ‚ö†Ô∏è Not uploaded yet                 ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îÇ                                                                     ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê ‚îÇ
‚îÇ ‚îÇ ACTIONS                                                         ‚îÇ ‚îÇ
‚îÇ ‚îÇ [Send Invoice] [Download PDF] [Mark as Paid] [Cancel Invoice]  ‚îÇ ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Sections:
1. Header with invoice number and status badge
2. Two-column info section (Invoice + Customer)
3. Amount Breakdown card with progress bar
4. Payment History section (collapsible cards)
5. Invoice Documents section (grid or list)
6. Action buttons at bottom

8.3 ADD PAYMENT MODAL
--------------------------------------------------------------------------------

Trigger: Click "+ Add Payment" button

Modal Content:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Add Payment                              [X]    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                 ‚îÇ
‚îÇ Invoice Amount: Rp 896.462.640                  ‚îÇ
‚îÇ PPh 23 Withheld: Rp 16.152.480                  ‚îÇ
‚îÇ Net Payable: Rp 880.310.160                     ‚îÇ
‚îÇ Outstanding: Rp 380.310.160                     ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ Payment Date: [___________] *                   ‚îÇ
‚îÇ Amount: [___________] *                         ‚îÇ
‚îÇ Payment Method: [Transfer ‚ñº]                    ‚îÇ
‚îÇ Reference Number: [___________]                 ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ ‚òê PPN Paid in this payment                     ‚îÇ
‚îÇ ‚òê PPh 23 Paid in this payment                  ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ Upload Bukti Bayar: [Choose File]              ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ Notes:                                          ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ ‚îÇ                                         ‚îÇ    ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ               [Cancel] [Save Payment]           ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Validations:
- Payment date is required
- Amount is required and must be > 0
- Amount must not exceed net_payable_amount (not invoice amount)
- Show warning if bukti bayar not uploaded

Note: Payment limit is net_payable_amount because PPh 23 is withheld

After Save:
- Insert payment_transaction
- Upload document if provided
- Update invoice paid_amount
- Auto-update invoice status
- Refresh detail page

8.4 UPLOAD DOCUMENT MODAL
--------------------------------------------------------------------------------

Trigger: Click "+ Upload" in Documents section

Modal Content:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Upload Document                          [X]    ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ                                                 ‚îÇ
‚îÇ Document Type: [Bukti Bayar ‚ñº] *               ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ Options:                                        ‚îÇ
‚îÇ - Bukti Bayar                                   ‚îÇ
‚îÇ - BUPOT PPh 23                                  ‚îÇ
‚îÇ - Bukti Bayar PPh                               ‚îÇ
‚îÇ - Bukti Bayar PPN                               ‚îÇ
‚îÇ - Faktur Pajak                                  ‚îÇ
‚îÇ - Other                                         ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ Link to Payment (optional):                     ‚îÇ
‚îÇ [Select Payment ‚ñº]                              ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ File: [Choose File] *                           ‚îÇ
‚îÇ Max size: 10MB                                  ‚îÇ
‚îÇ Formats: PDF, JPG, PNG                          ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ Notes:                                          ‚îÇ
‚îÇ ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îÇ
‚îÇ ‚îÇ                                         ‚îÇ    ‚îÇ
‚îÇ ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îÇ
‚îÇ                                                 ‚îÇ
‚îÇ               [Cancel] [Upload]                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Validations:
- Document type is required
- File is required
- File size <= 10MB
- File type must be PDF, JPG, or PNG

After Upload:
- Store file in /uploads/invoices/{invoice_id}/
- Insert record to invoice_documents
- Refresh documents section

8.5 RESPONSIVE DESIGN
--------------------------------------------------------------------------------

Desktop (>1024px):
- Full table view with all columns
- Side-by-side info cards
- Modal dialogs

Tablet (768px - 1024px):
- Reduced columns (hide less important)
- Stacked info cards
- Modal dialogs

Mobile (<768px):
- Card-based list view instead of table
- Single column layout
- Full-screen modals

================================================================================
9. MIGRATION STRATEGY
================================================================================

9.1 PHASE 1: DATABASE MIGRATION (Week 1)
--------------------------------------------------------------------------------

Day 1-2: Preparation
  - Review current database state
  - Backup production database
  - Test migration script on development

Day 3-4: Schema Changes
  - Execute ALTER TABLE statements (term_payments, recurring_payments)
  - Create new tables (payment_transactions, invoice_documents)
  - Create indexes
  - Create view (v_invoices)
  - Create helper functions

Day 5: Data Migration
  - Backfill existing data with new fields
  - Generate invoice numbers for existing records
  - Validate data integrity
  - Test queries on migrated data

Rollback Plan:
  - Keep backup
  - Drop new columns if needed
  - Restore from backup if critical issues

9.2 PHASE 2: BACKEND DEVELOPMENT (Week 2-3)
--------------------------------------------------------------------------------

Week 2: Core Services
  - Implement InvoiceService class
  - Payment transaction logic
  - Document upload handling
  - Status update logic
  - Unit tests for business logic

Week 3: API Development
  - Implement REST endpoints
  - Request validation
  - Error handling
  - API documentation
  - Integration tests

9.3 PHASE 3: FRONTEND DEVELOPMENT (Week 4-5)
--------------------------------------------------------------------------------

Week 4: Invoice List Page
  - UI components (cards, table, filters)
  - API integration
  - Export functionality
  - Responsive design

Week 5: Invoice Detail Page
  - Detail view components
  - Payment history section
  - Document management
  - Modal forms (add payment, upload doc)
  - Responsive design

9.4 PHASE 4: INTEGRATION & TESTING (Week 6)
--------------------------------------------------------------------------------

Day 1-2: Integration Testing
  - End-to-end workflows
  - Edge cases
  - Performance testing
  - Cross-browser testing

Day 3-4: User Acceptance Testing (UAT)
  - Deploy to staging
  - Train finance team
  - Collect feedback
  - Bug fixes

Day 5: Production Deployment
  - Deploy to production
  - Monitor for issues
  - Be ready for quick fixes

9.5 PHASE 5: POST-DEPLOYMENT (Week 7+)
--------------------------------------------------------------------------------

Week 7: Monitoring & Support
  - Monitor system performance
  - Address user feedback
  - Fix bugs
  - Optimize queries if needed

Week 8+: Enhancements
  - Implement Phase 2 features (email automation, etc)
  - Additional reports
  - Mobile app (if needed)

================================================================================
10. TESTING REQUIREMENTS
================================================================================

10.1 UNIT TESTS
--------------------------------------------------------------------------------

Backend Services:
‚úì InvoiceService.get_invoices_by_period()
  - Test with various filters
  - Test pagination
  - Test empty results

‚úì InvoiceService.add_payment()
  - Test partial payment
  - Test full payment
  - Test overpayment (should fail)
  - Test negative amount (should fail)
  - Test payment date validation

‚úì InvoiceService.update_invoice_status()
  - Test all status transitions
  - Test auto-update on payment
  - Test tax status logic

‚úì InvoiceService.upload_document()
  - Test file validation
  - Test duplicate filenames
  - Test unsupported formats

‚úì generate_invoice_number() function
  - Test unique generation
  - Test sequence increment
  - Test different periods

10.2 INTEGRATION TESTS
--------------------------------------------------------------------------------

API Endpoints:
‚úì GET /api/invoices
  - Test all filter combinations
  - Test pagination
  - Test performance with large datasets

‚úì POST /api/invoices/{type}/{id}/payments
  - Test payment creation
  - Test validation errors
  - Test concurrent payments

‚úì POST /api/invoices/{type}/{id}/documents
  - Test file upload
  - Test size limit
  - Test file type validation

Database:
‚úì Test triggers (update_invoice_status_trigger)
‚úì Test view performance (v_invoices)
‚úì Test cascading deletes

10.3 END-TO-END TESTS
--------------------------------------------------------------------------------

User Workflows:
‚úì Create contract ‚Üí Auto-generate invoices
‚úì View invoice list ‚Üí Filter by month
‚úì Open invoice detail ‚Üí Add payment
‚úì Add partial payment ‚Üí Verify status update
‚úì Add final payment ‚Üí Verify PAID status
‚úì Upload BUPOT ‚Üí Verify document appears
‚úì Export to Excel ‚Üí Verify file content

10.4 PERFORMANCE TESTS
--------------------------------------------------------------------------------

Benchmarks:
‚úì Invoice list page load < 2 seconds (1000 invoices)
‚úì Invoice detail page load < 1 second
‚úì Payment creation < 500ms
‚úì Document upload < 2 seconds (5MB file)
‚úì Export Excel < 5 seconds (500 records)

Load Tests:
‚úì 50 concurrent users viewing invoice list
‚úì 20 concurrent users adding payments
‚úì Database query performance with 10,000+ invoices

10.5 USER ACCEPTANCE TESTS
--------------------------------------------------------------------------------

Test Scenarios:
1. Finance staff adds payment for partial amount
2. Finance staff uploads multiple documents
3. Manager reviews invoice status by month
4. Manager exports Excel for reporting
5. Finance staff marks invoice as fully paid
6. System auto-updates status correctly
7. System prevents overpayment
8. System handles duplicate invoice numbers

Success Criteria:
- All critical workflows work smoothly
- No data loss or corruption
- Performance meets requirements
- UI is intuitive and user-friendly
- Finance team approves for production use

================================================================================
11. IMPLEMENTATION TIMELINE
================================================================================

TOTAL DURATION: 7 weeks

Week 1: Database Migration
  - Days 1-2: Preparation & backup
  - Days 3-4: Schema changes
  - Day 5: Data migration & validation

Week 2: Backend Core Services
  - InvoiceService implementation
  - Business logic
  - Unit tests

Week 3: Backend API Development
  - REST endpoints
  - Validation & error handling
  - API tests

Week 4: Frontend - Invoice List
  - UI components
  - API integration
  - Export functionality

Week 5: Frontend - Invoice Detail
  - Detail page components
  - Payment & document management
  - Modals & forms

Week 6: Integration & Testing
  - Integration tests
  - UAT with finance team
  - Bug fixes
  - Production deployment

Week 7+: Post-Deployment
  - Monitoring
  - User support
  - Enhancements

MILESTONES:
‚úì Week 1 End: Database migrated, data validated
‚úì Week 3 End: Backend API complete, tested
‚úì Week 5 End: Frontend complete, ready for UAT
‚úì Week 6 End: Production deployment
‚úì Week 7 End: Stable, users trained

================================================================================
12. APPENDIX
================================================================================

12.1 INVOICE NUMBER FORMAT
--------------------------------------------------------------------------------

Format: INV/YYYY/MM/XXXXX

Components:
- INV: Prefix
- YYYY: Billing year (4 digits)
- MM: Billing month (2 digits, zero-padded)
- XXXXX: Sequence number (5 digits, zero-padded)

Examples:
- INV/2026/01/00001 (first invoice of January 2026)
- INV/2026/01/00002 (second invoice of January 2026)
- INV/2026/12/00150 (150th invoice of December 2026)

Uniqueness:
- Unique across both term_payments and recurring_payments
- Sequence resets each month

12.2 STATUS ENUMS - TWO DIMENSIONS
--------------------------------------------------------------------------------

CRITICAL: The system tracks TWO SEPARATE status dimensions:

A. INVOICE_STATUS (Invoice Lifecycle) - NEW FIELD
   Tracks invoice payment and tax completion status

B. STATUS (Payment Due Timing) - EXISTING FIELD
   Tracks payment timing relative to period dates

Both fields must be tracked independently in the database.

--------------------------------------------------------------------------------
A. INVOICE_STATUS ENUM (Invoice Lifecycle)
--------------------------------------------------------------------------------

DRAFT
  Description: Auto-generated, not sent to customer yet
  Color: Gray
  Next: SENT (manual), CANCELLED (manual)

SENT
  Description: Sent to customer, awaiting payment
  Color: Blue
  Next: PARTIALLY_PAID (auto), PAID (auto), OVERDUE (auto)

PARTIALLY_PAID
  Description: Partial payment received
  Color: Orange
  Next: PAID (auto), PAID_PENDING_* (auto), OVERDUE (auto)

PAID
  Description: Fully paid including all taxes
  Color: Green
  Terminal: Yes

PAID_PENDING_PPH23
  Description: Fully paid, but PPh 23 tax not paid yet
  Color: Yellow
  Next: PAID (auto when pph23_paid = TRUE)

PAID_PENDING_PPH_PPN
  Description: Fully paid, but PPh 23 and/or PPN not paid yet
  Color: Orange-Yellow
  Next: PAID_PENDING_PPH23 (auto), PAID (auto)

OVERDUE
  Description: Past due date and not fully paid
  Color: Red
  Next: PARTIALLY_PAID (auto), PAID (auto)

CANCELLED
  Description: Invoice cancelled
  Color: Dark Gray
  Terminal: Yes

--------------------------------------------------------------------------------
B. STATUS ENUM (Payment Due Timing) - EXISTING FIELD
--------------------------------------------------------------------------------

PENDING
  Description: Future period (period_date > current_month)
  Auto-calculated: Yes
  Manual Override: No (always auto-calculated for non-terminal statuses)

DUE
  Description: Current period (period_date == current_month)
  Auto-calculated: Yes
  Manual Override: No (always auto-calculated for non-terminal statuses)

OVERDUE
  Description: Past period (period_date < current_month)
  Auto-calculated: Yes
  Manual Override: No (always auto-calculated for non-terminal statuses)

PAID
  Description: Payment fully completed
  Auto-calculated: No
  Manual Override: Yes (preserved, never auto-updated once set)

CANCELLED
  Description: Payment cancelled
  Auto-calculated: No
  Manual Override: Yes (preserved, never auto-updated once set)

Note: PAID and CANCELLED statuses are terminal and are never overwritten by
auto-update logic. All other statuses are recalculated based on period dates.

12.3 DUAL STATUS EXAMPLES
--------------------------------------------------------------------------------

Example scenarios showing how both status dimensions work together:

Scenario 1: Current month invoice, just sent
  invoice_status: "SENT"
  payment_due_status: "DUE"
  Meaning: Invoice sent to customer, payment is due this month

Scenario 2: Future month invoice, not yet sent
  invoice_status: "DRAFT"
  payment_due_status: "PENDING"
  Meaning: Invoice created but not sent, payment not due yet

Scenario 3: Past month invoice, partially paid
  invoice_status: "PARTIALLY_PAID"
  payment_due_status: "OVERDUE"
  Meaning: Some payment received, but invoice overdue

Scenario 4: Current month invoice, fully paid
  invoice_status: "PAID"
  payment_due_status: "PAID"
  Meaning: Invoice fully paid including taxes

Scenario 5: Past month invoice, paid but missing tax
  invoice_status: "PAID_PENDING_PPH23"
  payment_due_status: "PAID"
  Meaning: Main payment complete, but PPh 23 tax still pending

Scenario 6: Amount edited by staff (with PPh 23 withholding)
  Before edit:
    original_amount: 896,462,640 (preserved)
    amount: 896,462,640 (total invoice)
    base_amount: 807,624,000 (DPP)
    ppn_amount: 88,838,640 (11% PPN)
    pph_amount: 16,152,480 (2% withholding)
    net_payable_amount: 880,310,160 (what customer pays)

  After staff edits amount to 1,000,000,000:
    original_amount: 896,462,640 (unchanged - audit trail)
    amount: 1,000,000,000 (new value)
    base_amount: 900,900,901 (auto-recalc: 1B / 1.11)
    ppn_amount: 99,099,099 (auto-recalc: base √ó 0.11)
    pph_amount: 18,018,018 (auto-recalc: base √ó 0.02)
    net_payable_amount: 981,981,982 (auto-recalc: 1B - 18,018,018)

  Result: Staff can adjust invoice amount while:
    - Preserving original extracted value (audit trail)
    - Auto-recalculating all tax breakdown fields
    - Maintaining correct PPh 23 withholding logic

Scenario 7: Payment complete, waiting for BUPOT
  invoice_status: "PAID_PENDING_PPH23"
  payment_due_status: "PAID"
  paid_amount: 880,310,160 (equals net_payable_amount)
  pph23_paid: FALSE
  Meaning: Customer paid full net amount (Rp 880,310,160), but BUPOT document
           for PPh 23 (Rp 16,152,480) not yet uploaded by customer

12.4 DOCUMENT TYPES
--------------------------------------------------------------------------------

BUKTI_BAYAR
  Description: Proof of payment (bank transfer receipt)
  Required: Yes (for each payment)
  Linked to: payment_transaction

BUPOT_PPH23
  Description: Bukti Potong PPh 23
  Required: If pph23_paid = TRUE
  Linked to: invoice (general)

BUKTI_BAYAR_PPH
  Description: Proof of PPh 23 payment to tax office
  Required: If pph23_paid = TRUE
  Linked to: invoice (general)

BUKTI_BAYAR_PPN
  Description: Proof of PPN payment to tax office
  Required: If ppn_paid = TRUE
  Linked to: invoice (general)

INVOICE_PDF
  Description: Generated invoice PDF
  Required: Auto-generated
  Linked to: invoice (general)

FAKTUR_PAJAK
  Description: Tax invoice
  Required: Optional
  Linked to: invoice (general)

OTHER
  Description: Other supporting documents
  Required: No
  Linked to: invoice or payment

12.4 PAYMENT METHODS
--------------------------------------------------------------------------------

Supported methods:
- TRANSFER: Bank transfer
- CASH: Cash payment
- GIRO: Bank giro
- CHECK: Bank check
- VIRTUAL_ACCOUNT: Virtual account payment
- OTHER: Other methods

12.5 FILE STORAGE STRUCTURE
--------------------------------------------------------------------------------

Base path: /uploads/invoices/

Structure:
/uploads/invoices/
  ‚îú‚îÄ‚îÄ term-001/
  ‚îÇ   ‚îú‚îÄ‚îÄ invoice.pdf
  ‚îÇ   ‚îú‚îÄ‚îÄ payment-001-bukti.jpg
  ‚îÇ   ‚îú‚îÄ‚îÄ payment-002-bukti.jpg
  ‚îÇ   ‚îî‚îÄ‚îÄ bupot.pdf
  ‚îú‚îÄ‚îÄ recurring-001/
  ‚îÇ   ‚îú‚îÄ‚îÄ invoice.pdf
  ‚îÇ   ‚îî‚îÄ‚îÄ bukti_bayar.jpg
  ‚îî‚îÄ‚îÄ ...

Naming convention:
- invoice.pdf: System-generated invoice
- payment-{id}-bukti.{ext}: Payment proof
- bupot.pdf: BUPOT document
- bukti_bayar_pph.{ext}: PPh payment proof
- bukti_bayar_ppn.{ext}: PPN payment proof

12.6 SECURITY CONSIDERATIONS
--------------------------------------------------------------------------------

Authentication:
- JWT-based authentication
- Role-based access control (RBAC)

Roles & Permissions:
- Admin: Full access
- Finance Manager: Full access + approval workflows
- Finance Staff: Create, edit, view; upload documents
- Account Manager: View only (their contracts)

File Upload Security:
- Validate file type (whitelist)
- Validate file size (max 10MB)
- Scan for malware (optional)
- Store outside web root
- Generate random filenames
- Serve via controlled endpoint

Data Protection:
- HTTPS only
- Encrypt sensitive data at rest
- Audit trail for all changes
- Regular backups

12.7 MONITORING & ALERTS
--------------------------------------------------------------------------------

Metrics to Monitor:
- Invoice creation rate
- Payment processing time
- Failed payment attempts
- Overdue invoice count
- API response times
- Error rates

Alerts:
- Critical: Database connection failures
- High: API error rate > 5%
- Medium: Overdue invoices > 10
- Low: Weekly summary report

Logging:
- All API requests/responses
- Payment transactions
- Status changes
- File uploads
- Errors and exceptions

================================================================================
END OF ENHANCEMENT BRIEF
================================================================================

Document prepared by: Development Team
Approved by: [Pending Stakeholder Approval]

For questions or clarifications, contact the project lead.

Last updated: January 24, 2026
Version: 1.0
